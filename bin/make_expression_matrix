#!/usr/bin/env python

import pandas as pd
import numpy as np
import os

os.chdir(os.path.dirname(os.path.abspath(__file__)))

# read table
rna_raw = (
    pd.read_table('../data/SBRG_RNASeq_processed.tsv', sep='\t', header=0)
    .rename(columns={'bnum': 'locus_tag'})
)

# TODO this is wrong: all genes have same value across all conditions

# fix bnums
rna_raw.locus_tag = rna_raw.locus_tag.map(lambda x: x[:5])

# make "expression level" field
rna_raw['expression_level'] = rna_raw.baseMean * (rna_raw.log2FoldChange ** 2)

# make the matrix
rna_matrix = (
    rna_raw
    .pivot(index='locus_tag', columns='cond', values='expression_level')
    .dropna(how='any', axis='rows')
)

# log
rna_matrix_log = rna_matrix.applymap(lambda x: np.log2(x + 1))

# remove genes that are not expressed
# https://horvath.genetics.ucla.edu/html/CoexpressionNetwork/Rpackages/WGCNA/faq.html
raise NotImplementedError

# save it
rna_matrix_log.to_csv('../data/sbrg_rnaseq_matrix_log.tsv', sep='\t')
